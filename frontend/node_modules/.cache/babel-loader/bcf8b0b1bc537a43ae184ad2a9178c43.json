{"ast":null,"code":"import{useState,useEffect}from\"react\";import{useHistory}from\"react-router-dom\";import openSocket from\"../../services/socket-io\";import{toast}from\"react-toastify\";import{i18n}from\"../../translate/i18n\";import api from\"../../services/api\";import toastError from\"../../errors/toastError\";const useAuth=()=>{const history=useHistory();const[isAuth,setIsAuth]=useState(false);const[loading,setLoading]=useState(true);const[user,setUser]=useState({});api.interceptors.request.use(config=>{const token=localStorage.getItem(\"token\");if(token){config.headers[\"Authorization\"]=\"Bearer \".concat(JSON.parse(token));setIsAuth(true);}return config;},error=>{Promise.reject(error);});api.interceptors.response.use(response=>{return response;},async error=>{var _error$response,_error$response2;const originalRequest=error.config;if((error===null||error===void 0?void 0:(_error$response=error.response)===null||_error$response===void 0?void 0:_error$response.status)===403&&!originalRequest._retry){originalRequest._retry=true;const{data}=await api.post(\"/auth/refresh_token\");if(data){localStorage.setItem(\"token\",JSON.stringify(data.token));api.defaults.headers.Authorization=\"Bearer \".concat(data.token);}return api(originalRequest);}if((error===null||error===void 0?void 0:(_error$response2=error.response)===null||_error$response2===void 0?void 0:_error$response2.status)===401){localStorage.removeItem(\"token\");api.defaults.headers.Authorization=undefined;setIsAuth(false);}return Promise.reject(error);});useEffect(()=>{const token=localStorage.getItem(\"token\");(async()=>{if(token){try{const{data}=await api.post(\"/auth/refresh_token\");api.defaults.headers.Authorization=\"Bearer \".concat(data.token);setIsAuth(true);setUser(data.user);}catch(err){toastError(err);}}setLoading(false);})();},[]);useEffect(()=>{const socket=openSocket();socket.on(\"user\",data=>{if(data.action===\"update\"&&data.user.id===user.id){setUser(data.user);}});return()=>{socket.disconnect();};},[user]);const handleLogin=async userData=>{setLoading(true);try{const{data}=await api.post(\"/auth/login\",userData);localStorage.setItem(\"token\",JSON.stringify(data.token));api.defaults.headers.Authorization=\"Bearer \".concat(data.token);setUser(data.user);setIsAuth(true);toast.success(i18n.t(\"auth.toasts.success\"));history.push(\"/tickets\");setLoading(false);}catch(err){toastError(err);setLoading(false);}};const handleLogout=async()=>{setLoading(true);try{await api.delete(\"/auth/logout\");setIsAuth(false);setUser({});localStorage.removeItem(\"token\");api.defaults.headers.Authorization=undefined;setLoading(false);history.push(\"/login\");}catch(err){toastError(err);setLoading(false);}};return{isAuth,user,loading,handleLogin,handleLogout};};export default useAuth;","map":{"version":3,"names":["useState","useEffect","useHistory","openSocket","toast","i18n","api","toastError","useAuth","history","isAuth","setIsAuth","loading","setLoading","user","setUser","interceptors","request","use","config","token","localStorage","getItem","headers","concat","JSON","parse","error","Promise","reject","response","_error$response","_error$response2","originalRequest","status","_retry","data","post","setItem","stringify","defaults","Authorization","removeItem","undefined","err","socket","on","action","id","disconnect","handleLogin","userData","success","t","push","handleLogout","delete"],"sources":["/home/user/whaticket-free/frontend/src/hooks/useAuth.js/index.js"],"sourcesContent":["import { useState, useEffect } from \"react\";\nimport { useHistory } from \"react-router-dom\";\nimport openSocket from \"../../services/socket-io\";\n\nimport { toast } from \"react-toastify\";\n\nimport { i18n } from \"../../translate/i18n\";\nimport api from \"../../services/api\";\nimport toastError from \"../../errors/toastError\";\n\nconst useAuth = () => {\n\tconst history = useHistory();\n\tconst [isAuth, setIsAuth] = useState(false);\n\tconst [loading, setLoading] = useState(true);\n\tconst [user, setUser] = useState({});\n\n\tapi.interceptors.request.use(\n\t\tconfig => {\n\t\t\tconst token = localStorage.getItem(\"token\");\n\t\t\tif (token) {\n\t\t\t\tconfig.headers[\"Authorization\"] = `Bearer ${JSON.parse(token)}`;\n\t\t\t\tsetIsAuth(true);\n\t\t\t}\n\t\t\treturn config;\n\t\t},\n\t\terror => {\n\t\t\tPromise.reject(error);\n\t\t}\n\t);\n\n\tapi.interceptors.response.use(\n\t\tresponse => {\n\t\t\treturn response;\n\t\t},\n\t\tasync error => {\n\t\t\tconst originalRequest = error.config;\n\t\t\tif (error?.response?.status === 403 && !originalRequest._retry) {\n\t\t\t\toriginalRequest._retry = true;\n\n\t\t\t\tconst { data } = await api.post(\"/auth/refresh_token\");\n\t\t\t\tif (data) {\n\t\t\t\t\tlocalStorage.setItem(\"token\", JSON.stringify(data.token));\n\t\t\t\t\tapi.defaults.headers.Authorization = `Bearer ${data.token}`;\n\t\t\t\t}\n\t\t\t\treturn api(originalRequest);\n\t\t\t}\n\t\t\tif (error?.response?.status === 401) {\n\t\t\t\tlocalStorage.removeItem(\"token\");\n\t\t\t\tapi.defaults.headers.Authorization = undefined;\n\t\t\t\tsetIsAuth(false);\n\t\t\t}\n\t\t\treturn Promise.reject(error);\n\t\t}\n\t);\n\n\tuseEffect(() => {\n\t\tconst token = localStorage.getItem(\"token\");\n\t\t(async () => {\n\t\t\tif (token) {\n\t\t\t\ttry {\n\t\t\t\t\tconst { data } = await api.post(\"/auth/refresh_token\");\n\t\t\t\t\tapi.defaults.headers.Authorization = `Bearer ${data.token}`;\n\t\t\t\t\tsetIsAuth(true);\n\t\t\t\t\tsetUser(data.user);\n\t\t\t\t} catch (err) {\n\t\t\t\t\ttoastError(err);\n\t\t\t\t}\n\t\t\t}\n\t\t\tsetLoading(false);\n\t\t})();\n\t}, []);\n\n\tuseEffect(() => {\n\t\tconst socket = openSocket();\n\n\t\tsocket.on(\"user\", data => {\n\t\t\tif (data.action === \"update\" && data.user.id === user.id) {\n\t\t\t\tsetUser(data.user);\n\t\t\t}\n\t\t});\n\n\t\treturn () => {\n\t\t\tsocket.disconnect();\n\t\t};\n\t}, [user]);\n\n\tconst handleLogin = async userData => {\n\t\tsetLoading(true);\n\n\t\ttry {\n\t\t\tconst { data } = await api.post(\"/auth/login\", userData);\n\t\t\tlocalStorage.setItem(\"token\", JSON.stringify(data.token));\n\t\t\tapi.defaults.headers.Authorization = `Bearer ${data.token}`;\n\t\t\tsetUser(data.user);\n\t\t\tsetIsAuth(true);\n\t\t\ttoast.success(i18n.t(\"auth.toasts.success\"));\n\t\t\thistory.push(\"/tickets\");\n\t\t\tsetLoading(false);\n\t\t} catch (err) {\n\t\t\ttoastError(err);\n\t\t\tsetLoading(false);\n\t\t}\n\t};\n\n\tconst handleLogout = async () => {\n\t\tsetLoading(true);\n\n\t\ttry {\n\t\t\tawait api.delete(\"/auth/logout\");\n\t\t\tsetIsAuth(false);\n\t\t\tsetUser({});\n\t\t\tlocalStorage.removeItem(\"token\");\n\t\t\tapi.defaults.headers.Authorization = undefined;\n\t\t\tsetLoading(false);\n\t\t\thistory.push(\"/login\");\n\t\t} catch (err) {\n\t\t\ttoastError(err);\n\t\t\tsetLoading(false);\n\t\t}\n\t};\n\n\treturn { isAuth, user, loading, handleLogin, handleLogout };\n};\n\nexport default useAuth;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}