{"ast":null,"code":"import { useState, useEffect } from \"react\";\nimport { useHistory } from \"react-router-dom\";\nimport openSocket from \"../../services/socket-io\";\nimport { toast } from \"react-toastify\";\nimport { i18n } from \"../../translate/i18n\";\nimport api from \"../../services/api\";\nimport toastError from \"../../errors/toastError\";\nconst useAuth = () => {\n  const history = useHistory();\n  const [isAuth, setIsAuth] = useState(false);\n  const [loading, setLoading] = useState(true);\n  const [user, setUser] = useState({});\n  api.interceptors.request.use(config => {\n    const token = localStorage.getItem(\"token\");\n    if (token) {\n      config.headers[\"Authorization\"] = `Bearer ${JSON.parse(token)}`;\n      setIsAuth(true);\n    }\n    return config;\n  }, error => {\n    Promise.reject(error);\n  });\n  api.interceptors.response.use(response => {\n    return response;\n  }, async error => {\n    var _error$response, _error$response2;\n    const originalRequest = error.config;\n    if ((error === null || error === void 0 ? void 0 : (_error$response = error.response) === null || _error$response === void 0 ? void 0 : _error$response.status) === 403 && !originalRequest._retry) {\n      originalRequest._retry = true;\n      const {\n        data\n      } = await api.post(\"/auth/refresh_token\");\n      if (data) {\n        localStorage.setItem(\"token\", JSON.stringify(data.token));\n        api.defaults.headers.Authorization = `Bearer ${data.token}`;\n      }\n      return api(originalRequest);\n    }\n    if ((error === null || error === void 0 ? void 0 : (_error$response2 = error.response) === null || _error$response2 === void 0 ? void 0 : _error$response2.status) === 401) {\n      localStorage.removeItem(\"token\");\n      api.defaults.headers.Authorization = undefined;\n      setIsAuth(false);\n    }\n    return Promise.reject(error);\n  });\n  useEffect(() => {\n    const token = localStorage.getItem(\"token\");\n    (async () => {\n      if (token) {\n        try {\n          const {\n            data\n          } = await api.post(\"/auth/refresh_token\");\n          api.defaults.headers.Authorization = `Bearer ${data.token}`;\n          setIsAuth(true);\n          setUser(data.user);\n        } catch (err) {\n          toastError(err);\n        }\n      }\n      setLoading(false);\n    })();\n  }, []);\n  useEffect(() => {\n    const socket = openSocket();\n    socket.on(\"user\", data => {\n      if (data.action === \"update\" && data.user.id === user.id) {\n        setUser(data.user);\n      }\n    });\n    return () => {\n      socket.disconnect();\n    };\n  }, [user]);\n  const handleLogin = async userData => {\n    setLoading(true);\n    try {\n      const {\n        data\n      } = await api.post(\"/auth/login\", userData);\n      localStorage.setItem(\"token\", JSON.stringify(data.token));\n      api.defaults.headers.Authorization = `Bearer ${data.token}`;\n      setUser(data.user);\n      setIsAuth(true);\n      toast.success(i18n.t(\"auth.toasts.success\"));\n      history.push(\"/tickets\");\n      setLoading(false);\n    } catch (err) {\n      toastError(err);\n      setLoading(false);\n    }\n  };\n  const handleLogout = async () => {\n    setLoading(true);\n    try {\n      await api.delete(\"/auth/logout\");\n      setIsAuth(false);\n      setUser({});\n      localStorage.removeItem(\"token\");\n      api.defaults.headers.Authorization = undefined;\n      setLoading(false);\n      history.push(\"/login\");\n    } catch (err) {\n      toastError(err);\n      setLoading(false);\n    }\n  };\n  return {\n    isAuth,\n    user,\n    loading,\n    handleLogin,\n    handleLogout\n  };\n};\nexport default useAuth;","map":{"version":3,"names":["useState","useEffect","useHistory","openSocket","toast","i18n","api","toastError","useAuth","history","isAuth","setIsAuth","loading","setLoading","user","setUser","interceptors","request","use","config","token","localStorage","getItem","headers","JSON","parse","error","Promise","reject","response","_error$response","_error$response2","originalRequest","status","_retry","data","post","setItem","stringify","defaults","Authorization","removeItem","undefined","err","socket","on","action","id","disconnect","handleLogin","userData","success","t","push","handleLogout","delete"],"sources":["/home/user/whaticket-free/frontend/src/hooks/useAuth.js/index.js"],"sourcesContent":["import { useState, useEffect } from \"react\";\nimport { useHistory } from \"react-router-dom\";\nimport openSocket from \"../../services/socket-io\";\n\nimport { toast } from \"react-toastify\";\n\nimport { i18n } from \"../../translate/i18n\";\nimport api from \"../../services/api\";\nimport toastError from \"../../errors/toastError\";\n\nconst useAuth = () => {\n\tconst history = useHistory();\n\tconst [isAuth, setIsAuth] = useState(false);\n\tconst [loading, setLoading] = useState(true);\n\tconst [user, setUser] = useState({});\n\n\tapi.interceptors.request.use(\n\t\tconfig => {\n\t\t\tconst token = localStorage.getItem(\"token\");\n\t\t\tif (token) {\n\t\t\t\tconfig.headers[\"Authorization\"] = `Bearer ${JSON.parse(token)}`;\n\t\t\t\tsetIsAuth(true);\n\t\t\t}\n\t\t\treturn config;\n\t\t},\n\t\terror => {\n\t\t\tPromise.reject(error);\n\t\t}\n\t);\n\n\tapi.interceptors.response.use(\n\t\tresponse => {\n\t\t\treturn response;\n\t\t},\n\t\tasync error => {\n\t\t\tconst originalRequest = error.config;\n\t\t\tif (error?.response?.status === 403 && !originalRequest._retry) {\n\t\t\t\toriginalRequest._retry = true;\n\n\t\t\t\tconst { data } = await api.post(\"/auth/refresh_token\");\n\t\t\t\tif (data) {\n\t\t\t\t\tlocalStorage.setItem(\"token\", JSON.stringify(data.token));\n\t\t\t\t\tapi.defaults.headers.Authorization = `Bearer ${data.token}`;\n\t\t\t\t}\n\t\t\t\treturn api(originalRequest);\n\t\t\t}\n\t\t\tif (error?.response?.status === 401) {\n\t\t\t\tlocalStorage.removeItem(\"token\");\n\t\t\t\tapi.defaults.headers.Authorization = undefined;\n\t\t\t\tsetIsAuth(false);\n\t\t\t}\n\t\t\treturn Promise.reject(error);\n\t\t}\n\t);\n\n\tuseEffect(() => {\n\t\tconst token = localStorage.getItem(\"token\");\n\t\t(async () => {\n\t\t\tif (token) {\n\t\t\t\ttry {\n\t\t\t\t\tconst { data } = await api.post(\"/auth/refresh_token\");\n\t\t\t\t\tapi.defaults.headers.Authorization = `Bearer ${data.token}`;\n\t\t\t\t\tsetIsAuth(true);\n\t\t\t\t\tsetUser(data.user);\n\t\t\t\t} catch (err) {\n\t\t\t\t\ttoastError(err);\n\t\t\t\t}\n\t\t\t}\n\t\t\tsetLoading(false);\n\t\t})();\n\t}, []);\n\n\tuseEffect(() => {\n\t\tconst socket = openSocket();\n\n\t\tsocket.on(\"user\", data => {\n\t\t\tif (data.action === \"update\" && data.user.id === user.id) {\n\t\t\t\tsetUser(data.user);\n\t\t\t}\n\t\t});\n\n\t\treturn () => {\n\t\t\tsocket.disconnect();\n\t\t};\n\t}, [user]);\n\n\tconst handleLogin = async userData => {\n\t\tsetLoading(true);\n\n\t\ttry {\n\t\t\tconst { data } = await api.post(\"/auth/login\", userData);\n\t\t\tlocalStorage.setItem(\"token\", JSON.stringify(data.token));\n\t\t\tapi.defaults.headers.Authorization = `Bearer ${data.token}`;\n\t\t\tsetUser(data.user);\n\t\t\tsetIsAuth(true);\n\t\t\ttoast.success(i18n.t(\"auth.toasts.success\"));\n\t\t\thistory.push(\"/tickets\");\n\t\t\tsetLoading(false);\n\t\t} catch (err) {\n\t\t\ttoastError(err);\n\t\t\tsetLoading(false);\n\t\t}\n\t};\n\n\tconst handleLogout = async () => {\n\t\tsetLoading(true);\n\n\t\ttry {\n\t\t\tawait api.delete(\"/auth/logout\");\n\t\t\tsetIsAuth(false);\n\t\t\tsetUser({});\n\t\t\tlocalStorage.removeItem(\"token\");\n\t\t\tapi.defaults.headers.Authorization = undefined;\n\t\t\tsetLoading(false);\n\t\t\thistory.push(\"/login\");\n\t\t} catch (err) {\n\t\t\ttoastError(err);\n\t\t\tsetLoading(false);\n\t\t}\n\t};\n\n\treturn { isAuth, user, loading, handleLogin, handleLogout };\n};\n\nexport default useAuth;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}